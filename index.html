<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Slimme keuken - Recepten & Boodschappen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050609;
      --bg-elevated: #10131a;
      --bg-chip: #181b25;
      --accent: #3ecf8e;
      --accent-soft: rgba(62, 207, 142, 0.18);
      --accent-warn: #f5b914;
      --accent-error: #ff4d6a;
      --text: #f5f7ff;
      --muted: #a4a9c0;
      --border: #262a3a;
      --radius-lg: 16px;
      --radius-md: 10px;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.55);
      --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    /* LIGHT MODE VARIANT */
    :root.light {
      --bg: #ffffff;
      --bg-elevated: #f5f5f8;
      --bg-chip: #e4e4eb;
      --accent: #2ca86a;
      --accent-soft: rgba(44, 168, 106, 0.16);
      --accent-warn: #d49606;
      --accent-error: #d63757;
      --text: #111111;
      --muted: #555b6a;
      --border: #ceced9;
      background: #ffffff !important;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-sans);
      background: radial-gradient(circle at top, #20263b 0, #050609 55%);
      color: var(--text);
    }

    :root.light body {
      background: #ffffff;
    }

    .app {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }

    .header-top {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-start;
      justify-content: space-between;
    }

    .title-block h1 {
      margin: 0;
      font-size: 1.7rem;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .subtitle {
      margin-top: 4px;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .tabs {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      background: rgba(11, 13, 23, 0.94);
      border: 1px solid var(--border);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
      gap: 4px;
    }

    .tab-btn {
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--muted);
      padding: 6px 12px;
      font: inherit;
      font-size: 0.82rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      min-height: 28px;
    }

    .tab-btn span { font-size: 0.9rem; }

    .tab-btn.active {
      background: radial-gradient(circle at top left, #4af7af 0, #23b36f 40%, #1f8c58 100%);
      color: #020305;
      font-weight: 600;
      box-shadow: 0 10px 22px rgba(9, 233, 136, 0.32);
    }

    .theme-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.15);
      color: var(--text);
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: 0.25s;
      margin-left: 8px;
    }

    .theme-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    :root.light .tabs {
      background: rgba(255,255,255,0.8);
      border-color: var(--border);
    }

    :root.light .tab-btn.active {
      background: var(--accent);
      color: #fff;
    }

    .controls-card {
      background: linear-gradient(135deg, #111522 0, #080a11 60%, #050609 100%);
      border-radius: var(--radius-lg);
      padding: 18px 18px 16px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      margin-bottom: 16px;
    }

    :root.light .controls-card {
      background: #fafafa;
      box-shadow: 0 6px 22px rgba(0,0,0,0.08);
    }

    .controls-grid {
      display: grid;
      grid-template-columns: minmax(0, 190px) minmax(0, 1.3fr);
      gap: 16px 22px;
    }

    @media (max-width: 780px) {
      .controls-grid { grid-template-columns: minmax(0, 1fr); }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.86rem;
    }

    label { color: var(--muted); }

    input[type="number"],
    select,
    input[type="text"] {
      background: #090c14;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 7px 10px;
      font: inherit;
      min-height: 32px;
    }

    :root.light input[type="number"],
    :root.light select,
    :root.light input[type="text"] {
      background: #ffffff;
      color: var(--text);
    }

    input[type="number"]:focus,
    select:focus,
    input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(62, 207, 142, 0.25);
    }

    .field-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .field-row > * {
      flex: 1 1 auto;
      min-width: 90px;
    }

    button {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font: inherit;
    }

    .btn-primary {
      background: radial-gradient(circle at top left, #4af7af 0, #23b36f 40%, #1f8c58 100%);
      color: #020305;
      font-weight: 600;
      padding: 8px 16px;
      min-height: 34px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 12px 26px rgba(9, 233, 136, 0.32);
      white-space: nowrap;
    }

    .btn-secondary {
      background: var(--bg-chip);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px 12px;
      min-height: 32px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
    }

    .btn-ghost {
      background: transparent;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      color: var(--muted);
      padding: 4px 10px;
      font-size: 0.78rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-danger {
      background: rgba(255, 77, 106, 0.16);
      border: 1px solid rgba(255, 77, 106, 0.7);
      color: #ffb3c0;
      padding: 6px 12px;
      font-size: 0.8rem;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    :root.light .btn-secondary {
      background: #ececf2;
    }

    .pantry-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding-top: 4px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--bg-chip);
      border: 1px solid rgba(255, 255, 255, 0.04);
      color: var(--muted);
    }

    .chip strong { color: var(--text); }

    .chip button {
      border-radius: 999px;
      padding: 0 4px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 0.8rem;
      cursor: pointer;
    }

    .controls-footer {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-top: 14px;
    }

    .hint {
      font-size: 0.78rem;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
      max-width: 420px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      box-shadow: 0 0 0 3px rgba(62, 207, 142, 0.3);
    }

    .results-section {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .results-group {
      background: rgba(5, 7, 14, 0.85);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 14px 16px 10px;
    }

    :root.light .results-group {
      background: #f7f7fb;
    }

    .results-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .results-header h2 {
      margin: 0;
      font-size: 1rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .badge {
      font-size: 0.7rem;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      color: var(--muted);
    }

    .badge-green {
      border-color: rgba(62, 207, 142, 0.5);
      background: rgba(62, 207, 142, 0.12);
      color: var(--accent);
    }

    .badge-amber {
      border-color: rgba(245, 185, 20, 0.5);
      background: rgba(245, 185, 20, 0.08);
      color: var(--accent-warn);
    }

    .badge-red {
      border-color: rgba(255, 77, 106, 0.6);
      background: rgba(255, 77, 106, 0.08);
      color: var(--accent-error);
    }

    .results-empty {
      font-size: 0.8rem;
      color: var(--muted);
      padding: 6px 0 2px;
    }

    .recipes-list {
      display: grid;
      gap: 10px;
    }

    .recipe-card {
      border-radius: var(--radius-md);
      border: 1px solid rgba(255, 255, 255, 0.06);
      padding: 10px 12px;
      background: radial-gradient(circle at top left, #181b27 0, #080910 55%);
    }

    :root.light .recipe-card {
      background: #ffffff;
      border-color: #dedee8;
    }

    .recipe-title-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      margin-bottom: 4px;
    }

    .recipe-title-row h3 {
      margin: 0;
      font-size: 0.98rem;
    }

    .recipe-description {
      margin: 0;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .recipe-meta {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 0.76rem;
      color: var(--muted);
    }

    .macro-pill {
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    :root.light .macro-pill {
      background: #f1f1f8;
      border-color: #d7d7e4;
    }

    .missing-list {
      margin-top: 6px;
      font-size: 0.76rem;
      color: var(--muted);
    }

    .missing-list ul {
      margin: 3px 0 0;
      padding-left: 16px;
    }

    .tag {
      font-size: 0.72rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.06);
      color: var(--muted);
    }

    :root.light .tag {
      background: #ececf5;
      border-color: #d7d7e4;
    }

    .card-footer {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-end;
    }

    .screen { display: none; }
    .screen.active { display: block; }

    /* Shopping */
    .shopping-card {
      background: rgba(5, 7, 14, 0.92);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 16px 16px 14px;
      box-shadow: var(--shadow-soft);
      margin-top: 8px;
    }

    :root.light .shopping-card {
      background: #fafafa;
      box-shadow: 0 6px 22px rgba(0,0,0,0.08);
    }

    .shopping-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .shopping-header h2 {
      margin: 0;
      font-size: 1.05rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .shopping-subtitle {
      font-size: 0.84rem;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .shopping-list {
      list-style: none;
      margin: 0;
      padding: 0;
      font-size: 0.85rem;
    }

    .shopping-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    }

    :root.light .shopping-item {
      border-bottom-color: #e0e0ec;
    }

    .shopping-item:last-child { border-bottom: none; }

    .shopping-item input[type="checkbox"] {
      margin-top: 3px;
      accent-color: var(--accent);
    }

    .shopping-item-main { flex: 1 1 auto; }

    .shopping-item-title {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    .shopping-item-meta {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 2px;
    }

    .shopping-item-recipes {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 2px;
    }

    .badge-soft {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.06);
      color: var(--muted);
    }

    :root.light .badge-soft {
      background: #ececf5;
      border-color: #d7d7e4;
    }

    .shopping-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    /* Detail */
    .detail-card {
      background: rgba(5, 7, 14, 0.95);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 18px 18px 16px;
      box-shadow: var(--shadow-soft);
      margin-top: 8px;
    }

    :root.light .detail-card {
      background: #fafafa;
      box-shadow: 0 6px 22px rgba(0,0,0,0.08);
    }

    .detail-title-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
    }

    .detail-subtitle {
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 10px;
    }

    .detail-macros {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 0.8rem;
      margin-bottom: 12px;
    }

    .detail-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.2fr);
      gap: 18px;
    }

    @media (max-width: 760px) {
      .detail-layout { grid-template-columns: minmax(0, 1fr); }
    }

    .detail-box-title {
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .detail-ingredients-list {
      list-style: none;
      margin: 0;
      padding: 0;
      font-size: 0.83rem;
    }

    .detail-ingredients-list li {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      padding: 4px 0;
      border-bottom: 1px dashed rgba(255,255,255,0.06);
    }

    :root.light .detail-ingredients-list li {
      border-bottom-color: #d9d9e5;
    }

    .detail-steps {
      font-size: 0.86rem;
      color: var(--muted);
      margin: 0;
      white-space: pre-line;
    }

    .detail-footer {
      margin-top: 14px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .detail-footer-left {
      font-size: 0.8rem;
      color: var(--muted);
    }

    /* Altijd in huis popup */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal[aria-hidden="false"] {
      display: flex;
    }

    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
    }

    .modal-content {
      position: relative;
      max-width: 640px;
      width: 100%;
      max-height: 80vh;
      overflow: auto;
      background: var(--bg-elevated);
      border-radius: var(--radius-lg);
      padding: 16px 18px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
    }

    .modal-header {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }

    .modal-header h2 {
      margin: 0;
    }

    .modal-header p {
      margin: 0;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .modal-close {
      position: absolute;
      top: 8px;
      right: 10px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 1.1rem;
      cursor: pointer;
    }

    .modal-body {
      margin-top: 4px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .aih-section {
      margin-bottom: 10px;
    }

    .aih-section h3 {
      margin: 6px 0;
      font-size: 0.92rem;
    }

    .aih-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 12px;
    }

    .aih-item {
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 4px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="header-top">
        <div class="title-block">
          <h1>üçΩÔ∏è Slimme keuken</h1>
          <p class="subtitle">
            Vul je voorraad in, kies aantal personen, zie passende gerechten en bouw automatisch je boodschappenlijst.
          </p>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
          <div class="tabs">
            <button class="tab-btn active" data-screen="recipesScreen">
              <span>üìñ</span> Recepten
            </button>
            <button class="tab-btn" data-screen="shoppingScreen">
              <span>üß∫</span> Boodschappenlijst
            </button>
          </div>
          <button id="themeToggle" class="theme-btn" title="Wissel thema">üåô</button>
        </div>
      </div>
    </header>

    <!-- SCHERM 1: RECEPTEN -->
    <div id="recipesScreen" class="screen active">
      <section class="controls-card">
        <div class="controls-grid">
          <!-- Personen -->
          <div class="field">
            <label for="persons">Met hoeveel personen eet je?</label>
            <input type="number" id="persons" min="1" value="2" />
          </div>

          <!-- Ingredi√´nten toevoegen -->
          <div class="field">
            <label>Wat heb je in huis?</label>

            <!-- Zoekveld + favoriet-knop -->
            <div class="field-row" style="margin-bottom:6px;">
              <input
                type="text"
                id="ingredientSearch"
                placeholder="Zoek ingredi√´nt (bijv. kip, rijst, ui, pasta)..."
              />
              <button class="btn-secondary" id="toggleFavoriteBtn">
                ‚òÜ Favoriet
              </button>
            </div>

            <!-- Select + hoeveelheid -->
            <div class="field-row">
              <select id="ingredientSelect"></select>
              <input
                type="number"
                id="ingredientAmount"
                min="0"
                step="10"
                placeholder="Hoeveel?"
              />
              <select id="ingredientUnit">
                <option value="g">g</option>
                <option value="ml">ml</option>
                <option value="st">st</option>
                <option value="teen">teen</option>
                <option value="el">el</option>
                <option value="snuf">snuf</option>
              </select>
              <button class="btn-secondary" id="addIngredientBtn">
                + Voeg toe
              </button>
            </div>
            <div class="pantry-chips" id="pantryChips"></div>
          </div>
        </div>

        <div class="controls-footer">
          <div class="hint">
            <span class="dot"></span>
            <span>
              De app vergelijkt jouw voorraad met de recepten-database
              en schaalt alles op basis van het aantal personen.
            </span>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn-secondary" id="alwaysInHouseOpenBtn">
              ‚≠ê Altijd in huis instellen
            </button>
            <button class="btn-secondary" id="goToShoppingFromTop">
              üß∫ Bekijk boodschappenlijst
            </button>
            <button class="btn-primary" id="findRecipesBtn">
              üîç Vind passende gerechten
            </button>
          </div>
        </div>
      </section>

      <!-- Recept-zoekbalk + filters -->
      <section class="controls-card">
        <div class="controls-grid" style="grid-template-columns: repeat(4, minmax(0,1fr));">
          <div class="field">
            <label for="recipeSearch">Zoek in recepten</label>
            <input type="text" id="recipeSearch" placeholder="Zoek op naam, ingredi√´nt, etc." />
          </div>
          <div class="field">
            <label for="filterCategory">Categorie</label>
            <select id="filterCategory">
              <option value="all">Alle</option>
              <option value="meat">Vlees</option>
              <option value="fish">Vis</option>
              <option value="vega">Vega</option>
            </select>
          </div>
          <div class="field">
            <label for="filterMaxMissing">Max. ontbrekende ingredi√´nten</label>
            <select id="filterMaxMissing">
              <option value="999">Geen filter</option>
              <option value="0">0 (alles in huis)</option>
              <option value="2">2 of minder</option>
              <option value="5">5 of minder</option>
            </select>
          </div>
          <div class="field">
            <label for="filterMaxKcal">Max. kcal per persoon</label>
            <input type="number" id="filterMaxKcal" placeholder="bijv. 700" min="0" />
          </div>
        </div>
        <div class="controls-grid" style="margin-top:12px; grid-template-columns: repeat(3, minmax(0,1fr));">
          <div class="field">
            <label for="filterMaxTime">Max. kooktijd (min)</label>
            <select id="filterMaxTime">
              <option value="999">Geen filter</option>
              <option value="15">‚â§ 15 min</option>
              <option value="30">‚â§ 30 min</option>
              <option value="45">‚â§ 45 min</option>
              <option value="60">‚â§ 60 min</option>
            </select>
          </div>
          <div class="field">
            <label for="sortBy">Sorteer op</label>
            <select id="sortBy">
              <option value="recommended">Aanbevolen</option>
              <option value="missing-asc">Minder ontbrekend eerst</option>
              <option value="kcal-asc">Laagste kcal eerst</option>
              <option value="kcal-desc">Hoogste kcal eerst</option>
              <option value="time-asc">Kortste kooktijd eerst</option>
              <option value="title-asc">Naam (A‚ÄìZ)</option>
            </select>
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button class="btn-ghost" id="resetFiltersBtn">Filters resetten</button>
          </div>
        </div>
      </section>

      <!-- Resultaten -->
      <section class="results-section">
        <div class="results-group">
          <div class="results-header">
            <h2>‚úÖ Alles in huis</h2>
            <span class="badge badge-green" id="countAll"></span>
          </div>
          <div class="recipes-list" id="recipesAll"></div>
          <div class="results-empty" id="emptyAll">
            Nog geen gerechten. Vul je voorraad in en klik op "Vind passende gerechten".
          </div>
        </div>

        <div class="results-group">
          <div class="results-header">
            <h2>‚ö†Ô∏è Bijna alles in huis</h2>
            <span class="badge badge-amber" id="countAlmost"></span>
          </div>
          <div class="recipes-list" id="recipesAlmost"></div>
          <div class="results-empty" id="emptyAlmost">
            Hier verschijnen gerechten waarvoor je nog een paar dingen moet halen.
          </div>
        </div>

        <div class="results-group">
          <div class="results-header">
            <h2>‚õî Je mist nog veel</h2>
            <span class="badge-red badge" id="countMissing"></span>
          </div>
          <div class="recipes-list" id="recipesMissing"></div>
          <div class="results-empty" id="emptyMissing">
            Recepten die nu nog wat te ver van je voorraad afliggen.
          </div>
        </div>
      </section>
    </div>

    <!-- SCHERM 2: BOODSCHAPPENLIJST -->
    <div id="shoppingScreen" class="screen">
      <section class="shopping-card">
        <div class="shopping-header">
          <div>
            <h2>üß∫ Boodschappenlijst</h2>
            <p class="shopping-subtitle">
              Items die je vanuit recepten hebt toegevoegd. Vink af wat je gekocht of geregeld hebt.
            </p>
          </div>
          <span class="badge-soft" id="shoppingSummary">0 items</span>
        </div>

        <ul class="shopping-list" id="shoppingList"></ul>
        <div class="shopping-empty" id="shoppingEmpty">
          Je boodschappenlijst is nog leeg. Ga naar <strong>Recepten</strong> en klik
          op ‚ÄúZet ontbrekende op boodschappenlijst‚Äù.
        </div>

        <div class="shopping-footer">
          <button class="btn-secondary" id="backToRecipes">
            ‚¨ÖÔ∏è Terug naar recepten
          </button>
          <button class="btn-danger" id="clearShopping">
            üóëÔ∏è Maak lijst leeg
          </button>
        </div>
      </section>
    </div>

    <!-- SCHERM 3: RECEPTDETAILS -->
    <div id="detailScreen" class="screen">
      <section class="detail-card">
        <div class="detail-title-row">
          <h2 id="detailTitle">Recept titel</h2>
          <span class="tag" id="detailPersonsTag">2 pers</span>
        </div>
        <p class="detail-subtitle" id="detailDescription">Korte omschrijving...</p>

        <div class="detail-macros" id="detailMacros"></div>

        <div class="detail-layout">
          <div>
            <div class="detail-box-title">Ingredi√´nten & voorraad</div>
            <ul class="detail-ingredients-list" id="detailIngredientsList"></ul>
          </div>
          <div>
            <div class="detail-box-title">Bereidingswijze</div>
            <p class="detail-steps" id="detailSteps"></p>
          </div>
        </div>

        <div class="detail-footer">
          <div class="detail-footer-left" id="detailFooterInfo"></div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn-secondary" id="detailBackBtn">
              ‚¨ÖÔ∏è Terug naar recepten
            </button>
            <button class="btn-ghost" id="detailAddMissingBtn">
              üß∫ Zet ontbrekende op boodschappenlijst
            </button>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- ALTijd in huis POPUP -->
  <div id="alwaysInHouseModal" class="modal" aria-hidden="true">
    <div class="modal-backdrop"></div>

    <div class="modal-content">
      <header class="modal-header">
        <h2>Altijd in huis</h2>
        <p>Selecteer wat je standaard in huis hebt. Dit telt mee alsof je voorraad is aangevuld.</p>
        <button id="alwaysInHouseCloseBtn" class="modal-close">√ó</button>
      </header>

      <main class="modal-body">
        <!-- BASIS & HOUDBAAR -->
        <section class="aih-section">
          <h3>üçû Basis & houdbaar</h3>
          <div class="aih-grid">
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="pasta" />
              <span>Pasta</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="rijst" />
              <span>Rijst</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="aardappel" />
              <span>Aardappelen</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="olijfolie" />
              <span>Olijfolie</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="zonnebloemolie" />
              <span>Zonnebloemolie</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="zout" />
              <span>Zout</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="peper" />
              <span>Peper</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="suiker" />
              <span>Suiker</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="bloem" />
              <span>Bloem</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="bouillon" />
              <span>Bouillonblokjes</span>
            </label>
          </div>
        </section>

        <!-- VERSE BASIS -->
        <section class="aih-section">
          <h3>üßÖ Verse basis</h3>
          <div class="aih-grid">
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="ui" />
              <span>Ui</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="knoflook" />
              <span>Knoflook</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="paprika" />
              <span>Paprika</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="tomaat" />
              <span>Tomaten</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="komkommer" />
              <span>Komkommer</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="prei" />
              <span>Prei</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="wortel" />
              <span>Wortel</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="citroen" />
              <span>Citroen</span>
            </label>
          </div>
        </section>

        <!-- KRUIDEN -->
        <section class="aih-section">
          <h3>üßÇ Kruiden & specerijen</h3>
          <div class="aih-grid">
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="paprikapoeder" />
              <span>Paprikapoeder</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="kerrie" />
              <span>Kerriepoeder</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="italiaanse kruiden" />
              <span>Italiaanse kruiden</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="basilicum" />
              <span>Basilicum (droog)</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="oregano" />
              <span>Oregano</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="tijm" />
              <span>Tijm</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="chili" />
              <span>Chili flakes / chilipoeder</span>
            </label>
          </div>
        </section>

        <!-- SAUZEN & BLIK -->
        <section class="aih-section">
          <h3>ü•´ Sauzen & blik</h3>
          <div class="aih-grid">
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="tomatenpuree" />
              <span>Tomatenpuree</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="tomatensaus" />
              <span>Tomatensaus / passata</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="ketchup" />
              <span>Ketchup</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="mayonaise" />
              <span>Mayonaise</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="mosterd" />
              <span>Mosterd</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="sojasaus" />
              <span>Sojasaus / ketjap</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="bonen" />
              <span>Bonen (blik)</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="mais" />
              <span>Ma√Øs (blik)</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="tonijn" />
              <span>Tonijn (blik)</span>
            </label>
          </div>
        </section>

        <!-- ZUIVEL -->
        <section class="aih-section">
          <h3>üßÄ Zuivel & koeling</h3>
          <div class="aih-grid">
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="melk" />
              <span>Melk</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="yoghurt" />
              <span>Yoghurt</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="kaas" />
              <span>Kaas (geraspt/blok)</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="roomkaas" />
              <span>Roomkaas</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="room" />
              <span>Room / kookroom</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="ei" />
              <span>Eieren</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="boter" />
              <span>Roomboter / margarine</span>
            </label>
          </div>
        </section>

        <!-- VLEES / VIS / VEGA -->
        <section class="aih-section">
          <h3>ü•© Vlees, vis & vega</h3>
          <div class="aih-grid">
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="kip" />
              <span>Kipfilet</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="gehakt" />
              <span>Rundergehakt</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="spek" />
              <span>Spekblokjes</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="zalm" />
              <span>Zalm (vers/diepvries)</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="vega" />
              <span>Vega balletjes</span>
            </label>
            <label class="aih-item">
              <input type="checkbox" data-ingredient-name="tofu" />
              <span>Tofu</span>
            </label>
          </div>
        </section>
      </main>

      <footer class="modal-footer">
        <button class="btn-ghost" id="alwaysInHouseSelectAllBtn">
          Alles aanvinken
        </button>
        <button class="btn-ghost" id="alwaysInHouseClearBtn">
          Alles uitvinken
        </button>
        <button class="btn-secondary" id="alwaysInHouseApplyBtn">
          ‚úî Opslaan en gebruiken
        </button>
      </footer>
    </div>
  </div>

  <script>
    // ====== DATA CONTAINERS (worden gevuld via JSON) ======
    let ingredients = [];
    let recipes = [];
    let recipeIngredients = [];

    // ====== STATE ======
    const pantry = new Map();
    const shoppingList = new Map();

    let lastGroups = { all: [], almost: [], missing: [] };
    let currentPersons = 2;
    let detailCurrentRecipe = null;
    let detailCurrentMissingInfo = null;

    // Altijd in huis ingredients (ids)
    let alwaysInHouseIds = new Set();

    // DOM refs
    const ingredientSelectEl = document.getElementById("ingredientSelect");
    const ingredientAmountEl = document.getElementById("ingredientAmount");
    const ingredientUnitEl = document.getElementById("ingredientUnit");
    const pantryChipsEl = document.getElementById("pantryChips");
    const personsEl = document.getElementById("persons");
    const ingredientSearchEl = document.getElementById("ingredientSearch");
    const toggleFavoriteBtnEl = document.getElementById("toggleFavoriteBtn");

    const filterCategoryEl = document.getElementById("filterCategory");
    const filterMaxMissingEl = document.getElementById("filterMaxMissing");
    const filterMaxKcalEl = document.getElementById("filterMaxKcal");
    const filterMaxTimeEl = document.getElementById("filterMaxTime");
    const sortByEl = document.getElementById("sortBy");
    const recipeSearchEl = document.getElementById("recipeSearch");
    const resetFiltersBtnEl = document.getElementById("resetFiltersBtn");

    const recipesAllEl = document.getElementById("recipesAll");
    const recipesAlmostEl = document.getElementById("recipesAlmost");
    const recipesMissingEl = document.getElementById("recipesMissing");

    const emptyAllEl = document.getElementById("emptyAll");
    const emptyAlmostEl = document.getElementById("emptyAlmost");
    const emptyMissingEl = document.getElementById("emptyMissing");

    const countAllEl = document.getElementById("countAll");
    const countAlmostEl = document.getElementById("countAlmost");
    const countMissingEl = document.getElementById("countMissing");

    const shoppingListEl = document.getElementById("shoppingList");
    const shoppingEmptyEl = document.getElementById("shoppingEmpty");
    const shoppingSummaryEl = document.getElementById("shoppingSummary");

    const recipesScreenEl = document.getElementById("recipesScreen");
    const shoppingScreenEl = document.getElementById("shoppingScreen");
    const detailScreenEl = document.getElementById("detailScreen");
    const tabButtons = document.querySelectorAll(".tab-btn");

    const detailTitleEl = document.getElementById("detailTitle");
    const detailPersonsTagEl = document.getElementById("detailPersonsTag");
    const detailDescriptionEl = document.getElementById("detailDescription");
    const detailMacrosEl = document.getElementById("detailMacros");
    const detailIngredientsListEl = document.getElementById("detailIngredientsList");
    const detailStepsEl = document.getElementById("detailSteps");
    const detailFooterInfoEl = document.getElementById("detailFooterInfo");
    const detailAddMissingBtnEl = document.getElementById("detailAddMissingBtn");
    const detailBackBtnEl = document.getElementById("detailBackBtn");
    const themeToggleEl = document.getElementById("themeToggle");

    // Altijd in huis popup DOM
    const alwaysInHouseModalEl = document.getElementById("alwaysInHouseModal");
    const alwaysInHouseOpenBtnEl = document.getElementById("alwaysInHouseOpenBtn");
    const alwaysInHouseCloseBtnEl = document.getElementById("alwaysInHouseCloseBtn");
    const alwaysInHouseSelectAllBtnEl = document.getElementById("alwaysInHouseSelectAllBtn");
    const alwaysInHouseClearBtnEl = document.getElementById("alwaysInHouseClearBtn");
    const alwaysInHouseApplyBtnEl = document.getElementById("alwaysInHouseApplyBtn");
    const alwaysInHouseBackdropEl = alwaysInHouseModalEl.querySelector(".modal-backdrop");

    // ====== THEMA ======
    function applySavedTheme() {
      const saved = localStorage.getItem("theme") || "dark";
      const isLight = saved === "light";
      document.documentElement.classList.toggle("light", isLight);
      themeToggleEl.textContent = isLight ? "üåô" : "‚òÄÔ∏è";
    }

    themeToggleEl.addEventListener("click", () => {
      const isLight = document.documentElement.classList.toggle("light");
      localStorage.setItem("theme", isLight ? "light" : "dark");
      themeToggleEl.textContent = isLight ? "üåô" : "‚òÄÔ∏è";
    });

    applySavedTheme();

    // ====== SCHERMEN ======
    function switchScreen(screenId) {
      recipesScreenEl.classList.toggle("active", screenId === "recipesScreen");
      shoppingScreenEl.classList.toggle("active", screenId === "shoppingScreen");
      detailScreenEl.classList.toggle("active", screenId === "detailScreen");

      tabButtons.forEach((btn) => {
        if (screenId === "shoppingScreen") {
          btn.classList.toggle("active", btn.dataset.screen === "shoppingScreen");
        } else {
          btn.classList.toggle("active", btn.dataset.screen === "recipesScreen");
        }
      });
    }

    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => switchScreen(btn.dataset.screen));
    });

    document.getElementById("backToRecipes").addEventListener("click", () => {
      switchScreen("recipesScreen");
    });

    document.getElementById("goToShoppingFromTop").addEventListener("click", () => {
      switchScreen("shoppingScreen");
    });

    detailBackBtnEl.addEventListener("click", () => switchScreen("recipesScreen"));

    // ====== FAVORIETEN (INGREDI√ãNTEN) ======
    function ingFavorite(id) {
      const favIds = JSON.parse(localStorage.getItem("favorites") || "[]");
      return favIds.includes(id);
    }

    function setIngFavorite(id, isFav) {
      let favIds = JSON.parse(localStorage.getItem("favorites") || "[]");
      if (isFav && !favIds.includes(id)) favIds.push(id);
      if (!isFav) favIds = favIds.filter(x => x !== id);
      localStorage.setItem("favorites", JSON.stringify(favIds));
    }

    function loadFavorites() {
      const favIds = JSON.parse(localStorage.getItem("favorites") || "[]");
      return favIds;
    }

    function getFilteredSortedIngredients() {
      const search = ingredientSearchEl.value.trim().toLowerCase();
      return ingredients
        .filter(ing =>
          !search ||
          ing.name.toLowerCase().includes(search)
        )
        .sort((a, b) => {
          const favA = !!ingFavorite(a.id);
          const favB = !!ingFavorite(b.id);
          if (favA && !favB) return -1;
          if (!favA && favB) return 1;
          return a.name.localeCompare(b.name, "nl");
        });
    }

    function renderIngredientSelect(preserveSelected = true) {
      const previousId = preserveSelected ? parseInt(ingredientSelectEl.value, 10) || null : null;
      const list = getFilteredSortedIngredients();

      ingredientSelectEl.innerHTML = "";
      if (list.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Geen ingredi√´nten gevonden";
        ingredientSelectEl.appendChild(opt);
        ingredientSelectEl.disabled = true;
        toggleFavoriteBtnEl.disabled = true;
        toggleFavoriteBtnEl.textContent = "‚òÜ Favoriet";
        return;
      }

      ingredientSelectEl.disabled = false;

      list.forEach(ing => {
        const opt = document.createElement("option");
        opt.value = ing.id;
        opt.textContent = (ingFavorite(ing.id) ? "‚òÖ " : "") + ing.name;
        ingredientSelectEl.appendChild(opt);
      });

      if (previousId) {
        const found = list.find(ing => ing.id === previousId);
        if (found) ingredientSelectEl.value = previousId;
      }

      if (!ingredientSelectEl.value) {
        ingredientSelectEl.value = list[0].id;
      }

      updateFavoriteButtonState();
    }

    function updateFavoriteButtonState() {
      const ingId = parseInt(ingredientSelectEl.value, 10);
      const ing = ingredients.find(i => i.id === ingId);
      if (!ing) {
        toggleFavoriteBtnEl.disabled = true;
        toggleFavoriteBtnEl.textContent = "‚òÜ Favoriet";
        return;
      }
      toggleFavoriteBtnEl.disabled = false;
      toggleFavoriteBtnEl.textContent = ingFavorite(ingId) ? "‚òÖ Favoriet" : "‚òÜ Favoriet";
    }

    function initIngredientSelect() {
      renderIngredientSelect(false);
    }

    ingredientSearchEl.addEventListener("input", () => {
      renderIngredientSelect(false);
    });

    ingredientSelectEl.addEventListener("change", updateFavoriteButtonState);

    toggleFavoriteBtnEl.addEventListener("click", () => {
      const ingId = parseInt(ingredientSelectEl.value, 10);
      if (!ingId) return;
      const favNow = ingFavorite(ingId);
      setIngFavorite(ingId, !favNow);
      renderIngredientSelect(true);
    });

    // ====== LOCALSTORAGE: VOORRAAD, PERSONEN, FILTERS, LIJST ======
    function loadPantryFromStorage() {
      const saved = localStorage.getItem("pantry");
      if (!saved) return;
      try {
        const arr = JSON.parse(saved);
        arr.forEach(([id, obj]) => pantry.set(Number(id), obj));
      } catch {}
    }

    function savePantryToStorage() {
      localStorage.setItem("pantry", JSON.stringify(Array.from(pantry.entries())));
    }

    function loadPersonsFromStorage() {
      const saved = localStorage.getItem("persons");
      if (!saved) return;
      personsEl.value = saved;
      currentPersons = Math.max(1, parseInt(saved, 10) || 1);
    }

    function savePersonsToStorage() {
      localStorage.setItem("persons", personsEl.value);
    }

    function loadFiltersFromStorage() {
      const saved = localStorage.getItem("filters");
      if (!saved) return;
      try {
        const f = JSON.parse(saved);
        if (f.category) filterCategoryEl.value = f.category;
        if (f.maxMissing) filterMaxMissingEl.value = f.maxMissing;
        if (f.maxKcal) filterMaxKcalEl.value = f.maxKcal;
        if (f.maxTime) filterMaxTimeEl.value = f.maxTime;
        if (f.sortBy) sortByEl.value = f.sortBy;
        if (f.search) recipeSearchEl.value = f.search;
      } catch {}
    }

    function saveFiltersToStorage() {
      const state = {
        category: filterCategoryEl.value,
        maxMissing: filterMaxMissingEl.value,
        maxKcal: filterMaxKcalEl.value,
        maxTime: filterMaxTimeEl.value,
        sortBy: sortByEl.value,
        search: recipeSearchEl.value
      };
      localStorage.setItem("filters", JSON.stringify(state));
    }

    function loadShoppingListFromStorage() {
      const saved = localStorage.getItem("shoppingList");
      if (!saved) return;
      try {
        const arr = JSON.parse(saved);
        arr.forEach(item => {
          shoppingList.set(Number(item.id), {
            name: item.name,
            quantity: item.quantity,
            unit: item.unit,
            checked: item.checked,
            recipes: new Set(item.recipes || [])
          });
        });
      } catch {}
    }

    function saveShoppingListToStorage() {
      const plain = Array.from(shoppingList.entries()).map(([id, data]) => ({
        id,
        name: data.name,
        quantity: data.quantity,
        unit: data.unit,
        checked: data.checked,
        recipes: Array.from(data.recipes)
      }));
      localStorage.setItem("shoppingList", JSON.stringify(plain));
    }

    // ====== ALTIJD IN HUIS ======
    function loadAlwaysInHouseFromStorage() {
      try {
        const raw = localStorage.getItem("alwaysInHouse") || "[]";
        const arr = JSON.parse(raw);
        alwaysInHouseIds = new Set(arr.map(Number));
      } catch {
        alwaysInHouseIds = new Set();
      }
    }

    function saveAlwaysInHouseToStorage() {
      localStorage.setItem("alwaysInHouse", JSON.stringify(Array.from(alwaysInHouseIds)));
    }

    function syncAlwaysInHouseUIFromState() {
      const boxes = document.querySelectorAll('#alwaysInHouseModal input[type="checkbox"]');
      boxes.forEach((box) => {
        const name = (box.dataset.ingredientName || "").toLowerCase();
        if (!name) {
          box.checked = false;
          return;
        }
        const ing = ingredients.find((i) =>
          i.name.toLowerCase().includes(name)
        );
        if (!ing) {
          box.checked = false;
          return;
        }
        box.dataset.ingredientId = ing.id;
        box.checked = alwaysInHouseIds.has(ing.id);
      });
    }

    function openAlwaysInHouseModal() {
      syncAlwaysInHouseUIFromState();
      alwaysInHouseModalEl.setAttribute("aria-hidden", "false");
    }

    function closeAlwaysInHouseModal() {
      alwaysInHouseModalEl.setAttribute("aria-hidden", "true");
    }

    // ====== VOORRAAD CHIPS ======
    function renderPantryChips() {
      pantryChipsEl.innerHTML = "";
      if (pantry.size === 0) return;

      pantry.forEach((value, ingredientId) => {
        const ing = ingredients.find((i) => i.id === ingredientId);
        if (!ing) return;

        const chip = document.createElement("div");
        chip.className = "chip";
        const label = document.createElement("span");
        label.innerHTML = `<strong>${ing.name}</strong> &nbsp; ${value.quantity} ${value.unit}`;

        const removeBtn = document.createElement("button");
        removeBtn.textContent = "√ó";
        removeBtn.title = "Verwijder";
        removeBtn.addEventListener("click", () => {
          pantry.delete(ingredientId);
          savePantryToStorage();
          renderPantryChips();
        });

        chip.appendChild(label);
        chip.appendChild(removeBtn);
        pantryChipsEl.appendChild(chip);
      });
    }

    // ====== RECEPT LOGICA ======
    function getRecipeIngredients(recipeId) {
      return recipeIngredients.filter((ri) => ri.recipe_id === recipeId);
    }

    function calculateMissingForRecipe(recipe, persons) {
      const scale = persons / (recipe.baseServings || 1);
      const missing = [];
      const details = [];

      const rIngredients = getRecipeIngredients(recipe.id);

      rIngredients.forEach((ri) => {
        const needed = ri.amount * scale;
        const pantryItem = pantry.get(ri.ingredient_id);

        let have = pantryItem ? pantryItem.quantity : 0;

        // Altijd in huis: als niet in pantry maar wel in alwaysInHouseIds ‚Üí doen alsof we genoeg hebben
        if (!pantryItem && alwaysInHouseIds.has(ri.ingredient_id)) {
          have = needed;
        }

        const diff = needed - have;

        const ing = ingredients.find((i) => i.id === ri.ingredient_id);
        const ingName = ing ? ing.name : `Ingredi√´nt #${ri.ingredient_id}`;

        if (diff > 0.0001) {
          missing.push({
            ingredient_id: ri.ingredient_id,
            name: ingName,
            missing: diff,
            unit: ri.unit
          });
        }

        details.push({
          ingredient_id: ri.ingredient_id,
          name: ingName,
          needed,
          have,
          unit: ri.unit
        });
      });

      return { missing, details };
    }

    function classifyRecipe(missingList, totalIngredients) {
      if (missingList.length === 0) return "all";
      const ratio = missingList.length / totalIngredients;
      if (ratio <= 0.4) return "almost";
      return "missing";
    }

    function recipeMatchesSearch(recipe, term) {
      if (!term) return true;
      const t = term.toLowerCase();
      if (recipe.title.toLowerCase().includes(t)) return true;
      if (recipe.description && recipe.description.toLowerCase().includes(t)) return true;
      if (recipe.category && recipe.category.toLowerCase().includes(t)) return true;

      const rIng = getRecipeIngredients(recipe.id);
      for (const ri of rIng) {
        const ing = ingredients.find(i => i.id === ri.ingredient_id);
        if (ing && ing.name.toLowerCase().includes(t)) return true;
      }

      if (String(recipe.time || "").includes(t)) return true;

      return false;
    }

    // ====== BOODSCHAPPENLIJST ======
    function addMissingToShoppingList(recipe, missingList) {
      missingList.forEach((mi) => {
        const existing = shoppingList.get(mi.ingredient_id);
        if (existing) {
          existing.quantity += mi.missing;
          existing.recipes.add(recipe.title);
        } else {
          shoppingList.set(mi.ingredient_id, {
            name: mi.name,
            unit: mi.unit,
            quantity: mi.missing,
            recipes: new Set([recipe.title]),
            checked: false
          });
        }
      });
      saveShoppingListToStorage();
      renderShoppingList();
      switchScreen("shoppingScreen");
    }

    function renderShoppingList() {
      shoppingListEl.innerHTML = "";
      const items = Array.from(shoppingList.entries());

      if (items.length === 0) {
        shoppingEmptyEl.style.display = "block";
        shoppingSummaryEl.textContent = "0 items";
        return;
      }

      shoppingEmptyEl.style.display = "none";

      let uncheckedCount = 0;

      items.forEach(([ingredientId, item]) => {
        const li = document.createElement("li");
        li.className = "shopping-item";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = item.checked;
        checkbox.addEventListener("change", () => {
          item.checked = checkbox.checked;
          saveShoppingListToStorage();
          renderShoppingList();
        });

        const main = document.createElement("div");
        main.className = "shopping-item-main";

        const titleRow = document.createElement("div");
        titleRow.className = "shopping-item-title";

        const nameSpan = document.createElement("span");
        nameSpan.textContent = item.name;
        if (item.checked) {
          nameSpan.style.textDecoration = "line-through";
          nameSpan.style.color = "#6a7088";
        }

        const qtySpan = document.createElement("span");
        qtySpan.className = "badge-soft";
        const amountText =
          item.unit === "snuf"
            ? "snufje(s)"
            : `${Math.round(item.quantity * 10) / 10} ${item.unit}`;
        qtySpan.textContent = amountText;

        titleRow.appendChild(nameSpan);
        titleRow.appendChild(qtySpan);

        const meta = document.createElement("div");
        meta.className = "shopping-item-meta";
        meta.textContent = `Ingredi√´nt #${ingredientId}`;

        const recipesInfo = document.createElement("div");
        recipesInfo.className = "shopping-item-recipes";
        const recipeNames = Array.from(item.recipes);
        recipesInfo.textContent = "Voor: " + recipeNames.join(", ");

        main.appendChild(titleRow);
        main.appendChild(meta);
        main.appendChild(recipesInfo);

        li.appendChild(checkbox);
        li.appendChild(main);

        shoppingListEl.appendChild(li);

        if (!item.checked) uncheckedCount++;
      });

      shoppingSummaryEl.textContent = `${items.length} item(s) ‚Ä¢ ${uncheckedCount} open`;
    }

    function clearShoppingList() {
      if (shoppingList.size === 0) {
        alert("Je boodschappenlijst is al leeg üôÇ");
        return;
      }
      const ok = window.confirm(
        "Weet je zeker dat je de hele boodschappenlijst wilt leegmaken?"
      );
      if (!ok) return;

      shoppingList.clear();
      saveShoppingListToStorage();
      renderShoppingList();
      shoppingSummaryEl.textContent = "0 items";
    }

    document.getElementById("clearShopping").addEventListener("click", clearShoppingList);

    // ====== RECEPT KAART ======
    function createRecipeCard(recipe, persons, missingInfo) {
      const card = document.createElement("article");
      card.className = "recipe-card";

      const titleRow = document.createElement("div");
      titleRow.className = "recipe-title-row";

      const h3 = document.createElement("h3");
      h3.textContent = recipe.title;

      const tagWrap = document.createElement("div");
      tagWrap.style.display = "flex";
      tagWrap.style.gap = "4px";
      tagWrap.style.alignItems = "center";

      const tagPersons = document.createElement("span");
      tagPersons.className = "tag";
      tagPersons.textContent = persons + " pers";

      const tagCat = document.createElement("span");
      tagCat.className = "tag";
      tagCat.textContent =
        recipe.category === "meat" ? "Vlees" :
        recipe.category === "fish" ? "Vis" :
        "Vega";

      const tagTime = document.createElement("span");
      tagTime.className = "tag";
      tagTime.textContent = (recipe.time || 0) + " min";

      tagWrap.appendChild(tagPersons);
      tagWrap.appendChild(tagCat);
      tagWrap.appendChild(tagTime);

      titleRow.appendChild(h3);
      titleRow.appendChild(tagWrap);

      const desc = document.createElement("p");
      desc.className = "recipe-description";
      desc.textContent = recipe.description;

      const meta = document.createElement("div");
      meta.className = "recipe-meta";
      const totalKcal = Math.round(recipe.calories * persons);
      const totalProtein = Math.round(recipe.protein * persons);
      const totalCarbs = Math.round(recipe.carbs * persons);
      const totalFat = Math.round(recipe.fat * persons);

      const macroKcal = document.createElement("span");
      macroKcal.className = "macro-pill";
      macroKcal.textContent = `${totalKcal} kcal totaal`;

      const macroProt = document.createElement("span");
      macroProt.className = "macro-pill";
      macroProt.textContent = `${totalProtein}g eiwit`;

      const macroCarbs = document.createElement("span");
      macroCarbs.className = "macro-pill";
      macroCarbs.textContent = `${totalCarbs}g kh`;

      const macroFat = document.createElement("span");
      macroFat.className = "macro-pill";
      macroFat.textContent = `${totalFat}g vet`;

      meta.appendChild(macroKcal);
      meta.appendChild(macroProt);
      meta.appendChild(macroCarbs);
      meta.appendChild(macroFat);

      card.appendChild(titleRow);
      card.appendChild(desc);
      card.appendChild(meta);

      if (missingInfo.missing.length > 0) {
        const divMissing = document.createElement("div");
        divMissing.className = "missing-list";

        const label = document.createElement("div");
        label.innerHTML = "<strong>Je mist nog:</strong>";
        divMissing.appendChild(label);

        const ul = document.createElement("ul");
        missingInfo.missing.forEach((mi) => {
          const li = document.createElement("li");
          const amount =
            mi.unit === "snuf"
              ? "een snuf"
              : `${Math.round(mi.missing * 10) / 10} ${mi.unit}`;
          li.textContent = `${amount} ${mi.name}`;
          ul.appendChild(li);
        });
        divMissing.appendChild(ul);
        card.appendChild(divMissing);
      } else {
        const divOk = document.createElement("div");
        divOk.className = "missing-list";
        divOk.innerHTML = "<strong>Je hebt alles in huis üéâ</strong>";
        card.appendChild(divOk);
      }

      const footer = document.createElement("div");
      footer.className = "card-footer";

      const btnDetail = document.createElement("button");
      btnDetail.className = "btn-secondary";
      btnDetail.innerHTML = "üìÑ Details";
      btnDetail.addEventListener("click", () => {
        openDetailScreen(recipe, missingInfo, persons);
      });
      footer.appendChild(btnDetail);

      if (missingInfo.missing.length > 0) {
        const btnAdd = document.createElement("button");
        btnAdd.className = "btn-ghost";
        btnAdd.innerHTML = "üß∫ Zet ontbrekende op boodschappenlijst";
        btnAdd.addEventListener("click", () => {
          addMissingToShoppingList(recipe, missingInfo.missing);
        });
        footer.appendChild(btnAdd);
      }

      card.appendChild(footer);
      return card;
    }

    // ====== DETAIL SCREEN ======
    function openDetailScreen(recipe, missingInfo, persons) {
      detailCurrentRecipe = recipe;
      detailCurrentMissingInfo = missingInfo;

      detailTitleEl.textContent = recipe.title;
      detailPersonsTagEl.textContent = persons + " pers";
      detailDescriptionEl.textContent = recipe.description;
      detailStepsEl.textContent = (recipe.steps || []).join("\n");

      detailMacrosEl.innerHTML = "";
      const totalKcal = Math.round(recipe.calories * persons);
      const totalProtein = Math.round(recipe.protein * persons);
      const totalCarbs = Math.round(recipe.carbs * persons);
      const totalFat = Math.round(recipe.fat * persons);

      const mk = document.createElement("span");
      mk.className = "macro-pill";
      mk.textContent = `${totalKcal} kcal totaal`;

      const mp = document.createElement("span");
      mp.className = "macro-pill";
      mp.textContent = `${totalProtein}g eiwit`;

      const mc = document.createElement("span");
      mc.className = "macro-pill";
      mc.textContent = `${totalCarbs}g kh`;

      const mf = document.createElement("span");
      mf.className = "macro-pill";
      mf.textContent = `${totalFat}g vet`;

      detailMacrosEl.appendChild(mk);
      detailMacrosEl.appendChild(mp);
      detailMacrosEl.appendChild(mc);
      detailMacrosEl.appendChild(mf);

      detailIngredientsListEl.innerHTML = "";
      const scale = persons / (recipe.baseServings || 1);
      const rIngredients = getRecipeIngredients(recipe.id);

      rIngredients.forEach((ri) => {
        const ing = ingredients.find((i) => i.id === ri.ingredient_id);
        const name = ing ? ing.name : `Ingredi√´nt #${ri.ingredient_id}`;
        const needed = ri.amount * scale;
        const pantryItem = pantry.get(ri.ingredient_id);

        let have = pantryItem ? pantryItem.quantity : 0;
        if (!pantryItem && alwaysInHouseIds.has(ri.ingredient_id)) {
          have = needed;
        }

        const diff = needed - have;

        const li = document.createElement("li");

        const left = document.createElement("span");
        left.textContent = (ri.unit === "snuf"
          ? "snufje(s)"
          : `${Math.round(needed * 10) / 10} ${ri.unit}`) + " " + name;

        const right = document.createElement("span");
        if (diff <= 0.0001) {
          right.textContent = "Alles in huis";
        } else {
          const missText = ri.unit === "snuf"
            ? "ontbreekt"
            : `mis je ~${Math.round(diff * 10) / 10} ${ri.unit}`;
          right.textContent = pantryItem
            ? `Heb: ${Math.round(have * 10) / 10} ${ri.unit} ‚Ä¢ ${missText}`
            : `Niets in huis ‚Ä¢ ${missText}`;
        }

        li.appendChild(left);
        li.appendChild(right);
        detailIngredientsListEl.appendChild(li);
      });

      const totalIng = rIngredients.length;
      const missingCount = missingInfo.missing.length;
      if (missingCount === 0) {
        detailFooterInfoEl.textContent = "Je hebt alle ingredi√´nten in huis voor dit gerecht üéâ";
      } else {
        detailFooterInfoEl.textContent =
          `Je mist ${missingCount} van de ${totalIng} ingredi√´nten.`;
      }

      detailAddMissingBtnEl.onclick = () => {
        if (!detailCurrentRecipe || !detailCurrentMissingInfo) return;
        if (detailCurrentMissingInfo.missing.length === 0) {
          alert("Je mist niets meer voor dit gerecht üôÇ");
          return;
        }
        addMissingToShoppingList(detailCurrentRecipe, detailCurrentMissingInfo.missing);
      };

      switchScreen("detailScreen");
    }

    // ====== VIND GERECHTEN ======
    function findRecipesForPantry() {
      const persons = Math.max(1, parseInt(personsEl.value, 10) || 1);
      currentPersons = persons;
      savePersonsToStorage();

      const groups = { all: [], almost: [], missing: [] };

      recipes.forEach((recipe) => {
        const rIngredients = getRecipeIngredients(recipe.id);
        if (rIngredients.length === 0) return;

        const missingInfo = calculateMissingForRecipe(recipe, persons);
        const category = classifyRecipe(missingInfo.missing, rIngredients.length);
        groups[category].push({ recipe, missingInfo });
      });

      lastGroups = groups;
      applyFilters();
    }

    function clearResults() {
      recipesAllEl.innerHTML = "";
      recipesAlmostEl.innerHTML = "";
      recipesMissingEl.innerHTML = "";
    }

    function renderRecipeGroups(groups, persons) {
      clearResults();

      if (groups.all.length > 0) {
        emptyAllEl.style.display = "none";
        groups.all.forEach(({ recipe, missingInfo }) => {
          const card = createRecipeCard(recipe, persons, missingInfo);
          recipesAllEl.appendChild(card);
        });
      } else {
        emptyAllEl.style.display = "block";
      }

      if (groups.almost.length > 0) {
        emptyAlmostEl.style.display = "none";
        groups.almost.forEach(({ recipe, missingInfo }) => {
          const card = createRecipeCard(recipe, persons, missingInfo);
          recipesAlmostEl.appendChild(card);
        });
      } else {
        emptyAlmostEl.style.display = "block";
      }

      if (groups.missing.length > 0) {
        emptyMissingEl.style.display = "none";
        groups.missing.forEach(({ recipe, missingInfo }) => {
          const card = createRecipeCard(recipe, persons, missingInfo);
          recipesMissingEl.appendChild(card);
        });
      } else {
        emptyMissingEl.style.display = "block";
      }

      countAllEl.textContent =
        groups.all.length > 0 ? `${groups.all.length} gerecht(en)` : "0";
      countAlmostEl.textContent =
        groups.almost.length > 0 ? `${groups.almost.length} gerecht(en)` : "0";
      countMissingEl.textContent =
        groups.missing.length > 0 ? `${groups.missing.length} gerecht(en)` : "0";
    }

    // ====== FILTERS + SORTEREN + ZOEKEN ======
    function applyFilters() {
      const category = filterCategoryEl.value;
      const maxMissing = parseInt(filterMaxMissingEl.value, 10);
      const maxKcalVal = parseInt(filterMaxKcalEl.value, 10);
      const hasMaxKcal = !isNaN(maxKcalVal) && maxKcalVal > 0;
      const maxTimeVal = parseInt(filterMaxTimeEl.value, 10);
      const hasMaxTime = !isNaN(maxTimeVal) && maxTimeVal > 0 && maxTimeVal < 999;
      const sortBy = sortByEl.value;
      const searchTerm = recipeSearchEl.value.trim();

      saveFiltersToStorage();

      const combined = [];
      ["all", "almost", "missing"].forEach(groupName => {
        lastGroups[groupName].forEach(entry => {
          combined.push({ ...entry, group: groupName });
        });
      });

      const filteredGroups = { all: [], almost: [], missing: [] };

      combined.forEach(item => {
        const { recipe, missingInfo, group } = item;

        if (category !== "all" && recipe.category !== category) return;
        if (missingInfo.missing.length > maxMissing) return;
        if (hasMaxKcal && recipe.calories > maxKcalVal) return;
        if (hasMaxTime && (recipe.time || 999) > maxTimeVal) return;
        if (!recipeMatchesSearch(recipe, searchTerm)) return;

        filteredGroups[group].push({ recipe, missingInfo });
      });

      function sortList(list) {
        return list.sort((a, b) => {
          const missA = a.missingInfo.missing.length;
          const missB = b.missingInfo.missing.length;
          const kcalA = a.recipe.calories;
          const kcalB = b.recipe.calories;
          const timeA = a.recipe.time || 999;
          const timeB = b.recipe.time || 999;
          const titleA = a.recipe.title.toLowerCase();
          const titleB = b.recipe.title.toLowerCase();

          switch (sortBy) {
            case "missing-asc":
              if (missA !== missB) return missA - missB;
              return titleA.localeCompare(titleB, "nl");
            case "kcal-asc":
              if (kcalA !== kcalB) return kcalA - kcalB;
              return titleA.localeCompare(titleB, "nl");
            case "kcal-desc":
              if (kcalA !== kcalB) return kcalB - kcalA;
              return titleA.localeCompare(titleB, "nl");
            case "time-asc":
              if (timeA !== timeB) return timeA - timeB;
              return titleA.localeCompare(titleB, "nl");
            case "title-asc":
              return titleA.localeCompare(titleB, "nl");
            case "recommended":
            default:
              if (missA !== missB) return missA - missB;
              if (timeA !== timeB) return timeA - timeB;
              if (kcalA !== kcalB) return kcalA - kcalB;
              return titleA.localeCompare(titleB, "nl");
          }
        });
      }

      Object.keys(filteredGroups).forEach(groupName => {
        filteredGroups[groupName] = sortList(filteredGroups[groupName]);
      });

      renderRecipeGroups(filteredGroups, currentPersons);
    }

    resetFiltersBtnEl.addEventListener("click", () => {
      filterCategoryEl.value = "all";
      filterMaxMissingEl.value = "999";
      filterMaxKcalEl.value = "";
      filterMaxTimeEl.value = "999";
      sortByEl.value = "recommended";
      recipeSearchEl.value = "";
      saveFiltersToStorage();
      applyFilters();
    });

    filterCategoryEl.addEventListener("change", applyFilters);
    filterMaxMissingEl.addEventListener("change", applyFilters);
    filterMaxKcalEl.addEventListener("input", applyFilters);
    filterMaxTimeEl.addEventListener("change", applyFilters);
    sortByEl.addEventListener("change", applyFilters);
    recipeSearchEl.addEventListener("input", applyFilters);

    // ====== EVENTS ======
    document.getElementById("addIngredientBtn").addEventListener("click", () => {
      const ingId = parseInt(ingredientSelectEl.value, 10);
      const amount = parseFloat(ingredientAmountEl.value);
      const unit = ingredientUnitEl.value;

      if (!ingId || isNaN(amount) || amount <= 0) {
        alert("Kies een ingredi√´nt en vul een geldige hoeveelheid in.");
        return;
      }

      pantry.set(ingId, { quantity: amount, unit });
      savePantryToStorage();
      renderPantryChips();
      ingredientAmountEl.value = "";
    });

    document.getElementById("findRecipesBtn").addEventListener("click", findRecipesForPantry);

    personsEl.addEventListener("change", () => {
      currentPersons = Math.max(1, parseInt(personsEl.value, 10) || 1);
      savePersonsToStorage();
    });

    // Altijd-in-huis popup events
    alwaysInHouseOpenBtnEl.addEventListener("click", openAlwaysInHouseModal);
    alwaysInHouseCloseBtnEl.addEventListener("click", closeAlwaysInHouseModal);
    alwaysInHouseBackdropEl.addEventListener("click", closeAlwaysInHouseModal);

    alwaysInHouseSelectAllBtnEl.addEventListener("click", () => {
      document
        .querySelectorAll('#alwaysInHouseModal input[type="checkbox"]')
        .forEach((cb) => (cb.checked = true));
    });

    alwaysInHouseClearBtnEl.addEventListener("click", () => {
      document
        .querySelectorAll('#alwaysInHouseModal input[type="checkbox"]')
        .forEach((cb) => (cb.checked = false));
    });

    alwaysInHouseApplyBtnEl.addEventListener("click", () => {
      const boxes = document.querySelectorAll('#alwaysInHouseModal input[type="checkbox"]');
      alwaysInHouseIds.clear();

      boxes.forEach((box) => {
        if (!box.checked) return;
        const idStr = box.dataset.ingredientId;
        if (!idStr) return;
        alwaysInHouseIds.add(Number(idStr));
      });

      saveAlwaysInHouseToStorage();

      if (
        lastGroups.all.length > 0 ||
        lastGroups.almost.length > 0 ||
        lastGroups.missing.length > 0
      ) {
        applyFilters();
      }

      closeAlwaysInHouseModal();
    });

    // ====== JSON LADEN & INIT ======
    async function loadDataAndInit() {
      try {
        const [ingRes, recRes, recIngRes] = await Promise.all([
          fetch("ingredients.json"),
          fetch("recipes.json"),
          fetch("recipeIngredients.json")
        ]);

        if (!ingRes.ok || !recRes.ok || !recIngRes.ok) {
          throw new Error("Kon JSON-bestanden niet laden");
        }

        ingredients = await ingRes.json();
        recipes = await recRes.json();
        recipeIngredients = await recIngRes.json();

        loadFavorites();
        initIngredientSelect();

        loadAlwaysInHouseFromStorage();
        syncAlwaysInHouseUIFromState();

        loadPantryFromStorage();
        loadPersonsFromStorage();
        loadFiltersFromStorage();
        loadShoppingListFromStorage();

        renderPantryChips();
        renderShoppingList();
        renderRecipeGroups({ all: [], almost: [], missing: [] }, currentPersons);
      } catch (err) {
        console.error(err);
        alert("Er ging iets mis bij het laden van de data (JSON). Controleer of de bestanden in dezelfde map staan.");
      }
    }

    // ====== START ======
    loadDataAndInit();
  </script>
</body>
</html>
